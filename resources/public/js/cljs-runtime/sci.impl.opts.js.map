{"version":3,"sources":["sci/impl/opts.cljc"],"mappings":"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","names":["sci.impl.opts/namespace-syms","cljs.core/keys","sci.impl.namespaces/namespaces","sci.impl.opts/init-env!","env","bindings","aliases","namespaces","classes","raw-classes","imports","load-fn","async-load-fn","js-libs","ns-aliases","cljs.core.swap_BANG_","env-nss","cljs.core.merge_with","cljs.core/merge","or__5045__auto__","cljs.core.assoc","sci.impl.utils/user-ns","cljs.core.merge","cljs.core.get_in","cljs.core.update","cljs.core/assoc","sci.impl.utils.new_var","cljs.core/make-hierarchy","sci.impl.utils/clojure-core-ns","sci.impl.namespaces/loaded-libs**","cljs.core.concat","temp__5802__auto__","env-imports","cljs.core/not","var_args","args__5775__auto__","len__5769__auto__","i__5770__auto__","argseq__5776__auto__","cljs.core/IndexedSeq","sci.impl.opts/process-permissions","seq45171","G__45172","cljs.core/first","cljs.core/next","self__5754__auto__","prev-perms","permissions","cljs.core/not-empty","cljs.core.into","cljs.core.comp","cljs.core/cat","cljs.core.map","sci.impl.utils/strip-core-ns","p1__45179#","sci.impl.opts/default-classes","js/Error","msg","filename","line","cljs.core/PersistentQueue","goog.string/StringBuffer","sci.lang/Type","sci.impl.opts/default-imports","sci.impl.opts/stringify-keys","m","cljs.core/persistent!","cljs.core/reduce-kv","k","v","cljs.core.assoc_BANG_","cljs.core/name","cljs.core/transient","sci.impl.opts/normalize-classes","class->opts","cljs.core/select-keys","kvs","vec__45187","cljs.core.nth","sym","class-opts","cljs.core/map?","sm","cljs.core/rest","sci.impl.opts/default-reify-fn","_","sci.impl.opts/->ctx","features","readers","check-permissions?","sci.impl.opts/default-ns-aliases","p__45194","map__45195","cljs.core/--destructure-map","cljs.core.get","reify-fn","allow","deny","proxy-fn","sci.impl.opts/init","cljs.core.atom","ctx","sci.impl.opts.process_permissions","sci.impl.opts/merge-opts","opts","cljs.core/deref","map__45206","!env"],"sourcesContent":["(ns sci.impl.opts\n  {:no-doc true}\n  (:require\n   #?(:cljs [goog.string])\n   [sci.impl.namespaces :as namespaces]\n   [sci.impl.types]\n   [sci.impl.utils :as utils :refer [strip-core-ns]]\n   [sci.lang])\n  #?(:clj (:import\n           [sci.impl.types IReified])))\n\n#?(:clj\n   (defrecord Env [namespaces imports load-fn]))\n\n(def namespace-syms (keys namespaces/namespaces))\n\n(defn init-env! [env bindings aliases namespaces classes raw-classes imports\n                 load-fn #?(:cljs async-load-fn) #?(:cljs js-libs) ns-aliases]\n  (swap! env (fn [env]\n               (let [env-nss (:namespaces env)\n                     namespaces (merge-with merge\n                                            (or\n                                             ;; either the env has already got namespaces\n                                             env-nss\n                                             ;; or we need to install the default namespaces\n                                             namespaces/namespaces)\n                                            (when-not env-nss\n                                              ;; can skip when env has already got namespaces\n                                              {'user (assoc bindings\n                                                            :obj utils/user-ns)})\n                                            namespaces)\n                     aliases (merge aliases\n                                    (get-in env [:namespaces 'user :aliases]))\n                     namespaces (-> namespaces\n                                    (update 'user assoc :aliases aliases)\n                                    (update 'clojure.core assoc\n                                            'global-hierarchy\n                                            (utils/new-var 'global-hierarchy (make-hierarchy)\n                                                           {:ns utils/clojure-core-ns})\n                                            '*loaded-libs* (namespaces/loaded-libs**\n                                                            (concat (keys env-nss)\n                                                                    namespace-syms))))\n                     imports (if-let [env-imports (:imports env)]\n                               (merge env-imports imports)\n                               imports)\n                     ns-aliases (merge (:ns-aliases env) ns-aliases)\n                     #?@(:cljs [js-libs (merge (:js-libs env) js-libs)])]\n                 ;; TODO: is the first case ever hit?\n                 (if-not env\n                   #?(:clj (->Env namespaces imports load-fn)\n                      :cljs {:namespaces namespaces\n                             :imports imports\n                             :load-fn load-fn\n                             :async-load-fn async-load-fn})\n                   (assoc env\n                          :namespaces namespaces\n                          :imports imports\n                          :load-fn load-fn\n                          #?@(:cljs [:async-load-fn async-load-fn\n                                     :js-libs js-libs])\n                          :public-class (:public-class classes)\n                          :class->opts (:class->opts classes)\n                          :raw-classes raw-classes\n                          :ns-aliases ns-aliases))))))\n\n(defn process-permissions [prev-perms & permissions]\n  (not-empty (into prev-perms (comp cat (map strip-core-ns)) permissions)))\n\n(def default-classes\n  #?(:clj {'java.lang.AssertionError AssertionError\n           'java.lang.Exception {:class Exception}\n           'java.lang.IllegalArgumentException java.lang.IllegalArgumentException\n           'clojure.lang.Delay clojure.lang.Delay\n           'clojure.lang.ExceptionInfo clojure.lang.ExceptionInfo\n           'clojure.lang.LineNumberingPushbackReader clojure.lang.LineNumberingPushbackReader\n           'clojure.lang.LazySeq clojure.lang.LazySeq\n           'java.lang.String {:class String}\n           'java.io.StringWriter java.io.StringWriter\n           'java.io.StringReader java.io.StringReader\n           'java.lang.Integer Integer\n           'java.lang.Number Number\n           'java.lang.Double Double\n           'java.lang.ArithmeticException ArithmeticException\n           'java.lang.Object Object\n           'sci.lang.IVar sci.lang.IVar ;; deprecated\n           'sci.lang.Type sci.lang.Type\n           'sci.lang.Var sci.lang.Var}\n     :cljs {'Error {:class js/Error :constructor (fn\n                                                   ([msg] (js/Error. msg))\n                                                   ([msg filename] (js/Error. msg filename))\n                                                   ([msg filename line] (js/Error. msg filename line)))}\n            ;; this is here to satisfy the queue reader literal + advanced compilation\n            'cljs.core.PersistentQueue.EMPTY cljs.core/PersistentQueue.EMPTY\n            'goog.string.StringBuffer {:class goog.string/StringBuffer\n                                       :constructor #(goog.string/StringBuffer. %)}\n            'sci.lang.Type sci.lang.Type}))\n\n(def default-imports\n  #?(:clj '{AssertionError java.lang.AssertionError\n            Exception java.lang.Exception\n            String java.lang.String\n            ArithmeticException java.lang.ArithmeticException\n            Integer java.lang.Integer\n            Number java.lang.Number\n            Double java.lang.Double\n            Object java.lang.Object}\n     :cljs {}))\n\n(defn stringify-keys [m]\n  (persistent!\n   (reduce-kv (fn [m k v]\n                (assoc! m (name k) v)) (transient {}) m)))\n\n(comment\n  (stringify-keys {:foo 1})\n  )\n\n(defn normalize-classes [classes]\n  (loop [class->opts (transient (select-keys classes [:allow]))\n         kvs classes]\n    (if-let [[sym class-opts] (first kvs)]\n      (recur ;; storing the physical class as key didn't work well with\n       ;; GraalVM\n       (if (map? class-opts)\n         (if-let [sm (:static-methods class-opts)]\n           (-> (assoc! class->opts sym class-opts)\n               (assoc! :static-methods (assoc (:static-methods class->opts) (str sym) sm)))\n           (assoc! class->opts sym class-opts))\n         (assoc! class->opts sym {:class class-opts}))\n       (rest kvs))\n      {:public-class (:public-class classes)\n       :class->opts (persistent! class->opts)})))\n\n(def default-reify-fn\n  #?(:clj (fn [{:keys [interfaces methods protocols]}]\n            (reify\n              Object\n              (toString [this]\n                ((get methods 'toString) this))\n              IReified\n              (getInterfaces [_this]\n                interfaces)\n              (getMethods [_this]\n                methods)\n              (getProtocols [_this]\n                protocols)))\n     :cljs (fn [_ _ _])))\n\n#?(:clj (defrecord Ctx [bindings env\n                        features readers\n                        reload-all\n                        check-permissions]))\n\n(defn ->ctx [bindings env features readers check-permissions?]\n  #?(:cljs {:bindings bindings\n            :env env\n            :features features\n            :readers readers\n            :check-permissions check-permissions?}\n     :clj (->Ctx bindings env features readers false check-permissions?)))\n\n(def default-ns-aliases\n  #?(:clj {}\n     :cljs {;; in SCI the core namespace is always called clojure.core\n            'cljs.core 'clojure.core}))\n\n(defn init\n  \"Initializes options\"\n  [{:keys [:bindings :env\n           :allow :deny\n           :aliases\n           :namespaces\n           :classes\n           :imports\n           :features\n           :load-fn\n           :readers\n           :reify-fn\n           :proxy-fn\n           #?(:cljs :async-load-fn)\n           #?(:cljs :js-libs)\n           :ns-aliases]}]\n  (let [env (or env (atom {}))\n        imports (merge default-imports imports)\n        ns-aliases (merge default-ns-aliases ns-aliases)\n        bindings bindings\n        raw-classes (merge default-classes classes)\n        classes (normalize-classes raw-classes)\n        _ (init-env! env bindings aliases namespaces classes raw-classes imports\n                     load-fn #?(:cljs async-load-fn) #?(:cljs js-libs) ns-aliases)\n        ctx (assoc (->ctx {} env features readers (or allow deny))\n                   :allow (when allow (process-permissions #{} allow))\n                   :deny (when deny (process-permissions #{} deny))\n                   :reify-fn (or reify-fn default-reify-fn)\n                   :proxy-fn proxy-fn\n                   #?@(:clj [:main-thread-id (.getId (Thread/currentThread))]))]\n    ctx))\n\n(defn merge-opts [ctx opts]\n  (let [!env (:env ctx)\n        env @!env\n        {:keys [:bindings\n                :allow :deny\n                :aliases\n                :namespaces\n                :classes\n                :imports\n                :features\n                :load-fn\n                :readers\n                :reify-fn\n                #?(:cljs :async-load-fn)\n                #?(:cljs :js-libs)\n                :ns-aliases]\n         :or {load-fn (:load-fn env)\n              #?@(:cljs [async-load-fn (:async-load-fn env)])}} opts\n        raw-classes (merge (:raw-classes @!env) classes)\n        classes (normalize-classes raw-classes)\n        _ (init-env! !env bindings aliases namespaces classes raw-classes imports load-fn #?(:cljs async-load-fn) #?(:cljs js-libs) ns-aliases)\n        ctx (assoc (->ctx {} !env features readers (or (:check-permissions ctx) allow deny))\n                   :allow (when allow (process-permissions (:allow ctx) allow))\n                   :deny (when deny (process-permissions (:deny ctx) deny))\n                   :reify-fn reify-fn\n                   :main-thread-id (:main-thread-id ctx))]\n    ctx))\n"]}